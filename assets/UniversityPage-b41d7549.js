import{k as le,l as ce,r as m,v as Y,w as A,x as g,j as e,B as C,T as f,C as K,E as de,F as q,G as ue,H as he}from"./index-3658deca.js";import{P as me}from"./PageContainer-f13e2725.js";import{D as pe}from"./DashboardCard-64a0b147.js";import{T as k}from"./Tooltip-da4e2ab3.js";import{C as S}from"./Chip-b97668ec.js";import{T as D}from"./TextField-71b5574c.js";import{I as xe,a as O,b as V,c as J,D as fe,d as je,e as ve,f as ge,S as Ce}from"./IconTrash-4b65ec6a.js";import{B as E}from"./Button-2fd948b0.js";import{A as Q}from"./Alert-15fa0127.js";import{T as ye}from"./TableContainer-e65c528a.js";import{P as be}from"./Paper-4e5249aa.js";import{T as we,a as Se,b as R,c as i,d as De}from"./TableRow-b1e797ea.js";import{I as P}from"./IconButton-228a1632.js";import{G as y}from"./Grid-1a565d43.js";import"./Card-a43a000b.js";import"./CardContent-0002688a.js";import"./Stack-5171aadf.js";import"./styled-1bc89e08.js";import"./useTheme-eb7184cb.js";import"./Menu-fdb2746e.js";import"./ButtonBase-4177e0d6.js";import"./Select-8b79b68d.js";import"./isMuiElement-00f6e4f3.js";import"./createReactComponent-f455f93b.js";const Te=p=>{switch(p){case"admin":return"error";case"moderator":return"warning";case"editor":return"success";case"user":return"info";default:return"default"}},Ze=()=>{const{currentUser:p,userRole:n,isAdmin:ze,hasRole:Ie}=le();ce();const x={canView:!0,canCreate:n==="admin"||n==="editor",canUpdate:n==="admin"||n==="editor"||n==="moderator",canDelete:n==="admin"},[X,Z]=m.useState([]),[B,j]=m.useState(!0),[M,ee]=m.useState(null),[F,b]=m.useState(!1),[w,$]=m.useState("add"),[W,se]=m.useState(""),[r,T]=m.useState({name:"",state:"",address:"",website:"",coursesCount:0,scholarshipsCount:0}),[z,c]=m.useState({open:!1,message:"",severity:"success"}),_=s=>{if(!s)return"";const t=s.split(",").map(d=>d.trim()),o=["Selangor","Kuala Lumpur","Penang","Johor","Perak","Sabah","Sarawak","Melaka","Negeri Sembilan","Kedah","Pahang","Terengganu","Kelantan","Perlis","Labuan","Putrajaya"];for(const d of t)for(const v of o)if(d.includes(v))return v;return t.length>=2?t[t.length-2]:""};m.useEffect(()=>{N()},[]);const N=async()=>{try{j(!0);const s=await Y(A(g,"universities")),t=await Y(A(g,"courses")),o=await Y(A(g,"scholarships")),d={},v={};t.docs.forEach(h=>{const a=h.data().university_id;a&&(d[a]=(d[a]||0)+1)}),o.docs.forEach(h=>{const a=h.data().university_id;a&&(v[a]=(v[a]||0)+1)});const u=s.docs.map(h=>{const l=h.data();let a="",L="";l.location&&l.location.address?(a=l.location.address,L=_(a)):l.contact_info&&l.contact_info.address&&(a=l.contact_info.address,L=_(a));const ne=d[h.id]||l.coursesCount||0,oe=v[h.id]||l.scholarshipsCount||0;return{id:h.id,...l,address:a,state:L,coursesCount:ne,scholarshipsCount:oe}});Z(u),j(!1)}catch(s){console.error("Error fetching universities:",s),ee("Failed to load universities. Please try again."),j(!1)}},te=()=>{if(!x.canCreate){c({open:!0,message:"You do not have permission to add universities",severity:"error"});return}T({name:"",state:"",address:"",website:"",coursesCount:0,scholarshipsCount:0}),$("add"),b(!0)},re=s=>{if(!x.canUpdate){c({open:!0,message:"You do not have permission to edit universities",severity:"error"});return}T({id:s.id,name:s.name||"",state:s.state||"",address:s.address||"",website:s.website||"",coursesCount:s.coursesCount||0,scholarshipsCount:s.scholarshipsCount||0}),$("edit"),b(!0)},I=s=>{const{name:t,value:o}=s.target;if(t==="address"){const d=_(o);T({...r,address:o,state:d})}else T({...r,[t]:o})},ae=async()=>{var s;if(w==="add"&&!x.canCreate||w==="edit"&&!x.canUpdate){c({open:!0,message:`You do not have permission to ${w==="add"?"create":"update"} universities`,severity:"error"});return}try{j(!0);const{id:t,state:o,coursesCount:d,scholarshipsCount:v,...u}=r;if(r.address&&(u.location={address:r.address,coordinates:((s=u.location)==null?void 0:s.coordinates)||{lat:0,lng:0}}),u.updated_at=new Date,u.updated_by=p==null?void 0:p.uid,w==="add")u.created_at=new Date,u.created_by=p==null?void 0:p.uid,await de(A(g,"universities"),u),c({open:!0,message:"University added successfully!",severity:"success"});else{const h=q(g,"universities",t);await ue(h,u,{merge:!0}),c({open:!0,message:"University updated successfully!",severity:"success"})}b(!1),N()}catch(t){console.error("Error saving university:",t),c({open:!0,message:`Error: ${t.message}`,severity:"error"})}finally{j(!1)}},ie=async s=>{if(!x.canDelete){c({open:!0,message:"You do not have permission to delete universities",severity:"error"});return}if(window.confirm("Are you sure you want to delete this university?"))try{j(!0),await he(q(g,"universities",s)),c({open:!0,message:"University deleted successfully!",severity:"success"}),N()}catch(t){console.error("Error deleting university:",t),c({open:!0,message:`Error: ${t.message}`,severity:"error"})}finally{j(!1)}},G=()=>{c({...z,open:!1})},H=X.filter(s=>{var t,o;return((t=s.name)==null?void 0:t.toLowerCase().includes(W.toLowerCase()))||((o=s.state)==null?void 0:o.toLowerCase().includes(W.toLowerCase()))}),U=s=>s>=10?"success":s>=5?"primary":s>=1?"info":"default";return e.jsxs(me,{title:"University Management",description:"Manage all universities",children:[e.jsxs(pe,{title:e.jsxs(C,{display:"flex",alignItems:"center",children:[e.jsx(f,{variant:"h4",children:"Universities"}),n&&n!=="admin"&&e.jsx(k,{title:`You have ${n} privileges`,children:e.jsx(S,{label:n.charAt(0).toUpperCase()+n.slice(1),size:"small",color:Te(n),sx:{ml:2}})})]}),children:[e.jsxs(C,{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(C,{display:"flex",alignItems:"center",children:e.jsx(D,{size:"small",placeholder:"Search universities...",value:W,onChange:s=>se(s.target.value),sx:{width:300},InputProps:{startAdornment:e.jsx(xe,{size:"20",style:{marginRight:"8px"}})}})}),x.canCreate?e.jsx(E,{variant:"contained",color:"primary",startIcon:e.jsx(O,{size:"18"}),onClick:te,children:"Add University"}):e.jsx(k,{title:"You don't have permission to add universities",children:e.jsx("span",{children:e.jsx(E,{variant:"contained",color:"primary",startIcon:e.jsx(O,{size:"18"}),disabled:!0,children:"Add University"})})})]}),B&&!F?e.jsx(C,{display:"flex",justifyContent:"center",alignItems:"center",py:4,children:e.jsx(K,{})}):M?e.jsx(Q,{severity:"error",children:M}):e.jsx(ye,{component:be,sx:{boxShadow:"none"},children:e.jsxs(we,{sx:{minWidth:650},"aria-label":"universities table",children:[e.jsx(Se,{children:e.jsxs(R,{children:[e.jsx(i,{children:"University Name"}),e.jsx(i,{children:"State"}),e.jsx(i,{children:"Courses"}),e.jsx(i,{children:"Scholarships"}),e.jsx(i,{children:"Website"}),e.jsx(i,{children:"Actions"})]})}),e.jsx(De,{children:H.length>0?H.map(s=>e.jsxs(R,{children:[e.jsx(i,{children:e.jsx(f,{variant:"subtitle2",fontWeight:600,children:s.name})}),e.jsx(i,{children:s.state||"N/A"}),e.jsx(i,{children:e.jsx(S,{label:s.coursesCount||"0",size:"small",color:U(s.coursesCount)})}),e.jsx(i,{children:e.jsx(S,{label:s.scholarshipsCount||"0",size:"small",color:U(s.scholarshipsCount)})}),e.jsx(i,{children:s.website?e.jsx(f,{variant:"body2",sx:{textDecoration:"underline",color:"primary.main",cursor:"pointer"},onClick:()=>window.open(s.website,"_blank"),children:"Visit Website"}):"N/A"}),e.jsxs(i,{children:[x.canUpdate?e.jsx(P,{color:"primary",size:"small",onClick:()=>re(s),children:e.jsx(V,{size:"18"})}):e.jsx(k,{title:"You don't have permission to edit",children:e.jsx("span",{children:e.jsx(P,{color:"primary",size:"small",disabled:!0,children:e.jsx(V,{size:"18"})})})}),x.canDelete?e.jsx(P,{color:"error",size:"small",onClick:()=>ie(s.id),children:e.jsx(J,{size:"18"})}):e.jsx(k,{title:"You don't have permission to delete",children:e.jsx("span",{children:e.jsx(P,{color:"error",size:"small",disabled:!0,children:e.jsx(J,{size:"18"})})})})]})]},s.id)):e.jsx(R,{children:e.jsx(i,{colSpan:6,align:"center",children:e.jsx(f,{variant:"body2",color:"textSecondary",py:2,children:"No universities found."})})})})]})})]}),e.jsxs(fe,{open:F,onClose:()=>b(!1),fullWidth:!0,maxWidth:"sm",children:[e.jsx(je,{children:w==="add"?"Add New University":"Edit University"}),e.jsx(ve,{children:e.jsxs(y,{container:!0,spacing:2,sx:{mt:.5},children:[e.jsx(y,{item:!0,xs:12,children:e.jsx(D,{fullWidth:!0,label:"University Name",name:"name",value:r.name,onChange:I,required:!0})}),e.jsx(y,{item:!0,xs:12,children:e.jsx(D,{fullWidth:!0,label:"Address",name:"address",value:r.address,onChange:I,required:!0,helperText:"State will be automatically extracted from address"})}),e.jsx(y,{item:!0,xs:12,sm:6,children:e.jsx(D,{fullWidth:!0,label:"State",name:"state",value:r.state,onChange:I,disabled:!0,helperText:"Auto-detected from address"})}),e.jsx(y,{item:!0,xs:12,sm:6,children:e.jsx(D,{fullWidth:!0,label:"Website",name:"website",value:r.website,onChange:I,placeholder:"e.g. https://www.university.edu"})}),e.jsxs(y,{item:!0,xs:12,children:[e.jsx(f,{variant:"subtitle2",sx:{mt:2,mb:1},children:"Course & Scholarship Counts"}),e.jsx(f,{variant:"body2",color:"textSecondary",sx:{mb:2},children:"These counts will be automatically updated when courses and scholarships are added or removed."}),e.jsxs(C,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(f,{variant:"body2",sx:{width:120},children:"Courses:"}),e.jsx(S,{label:r.coursesCount||"0",size:"small",color:U(r.coursesCount),sx:{mr:1}})]}),e.jsxs(C,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(f,{variant:"body2",sx:{width:120},children:"Scholarships:"}),e.jsx(S,{label:r.scholarshipsCount||"0",size:"small",color:U(r.scholarshipsCount)})]})]})]})}),e.jsxs(ge,{children:[e.jsx(E,{onClick:()=>b(!1),children:"Cancel"}),e.jsx(E,{onClick:ae,variant:"contained",color:"primary",disabled:!r.name||!r.address,children:B?e.jsx(K,{size:24}):"Save"})]})]}),e.jsx(Ce,{open:z.open,autoHideDuration:6e3,onClose:G,anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(Q,{onClose:G,severity:z.severity,variant:"filled",children:z.message})})]})};export{Ze as default};
